<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Blog - Varivashyap</title>
  <link rel="stylesheet" href="styles.css" />
  <meta name="description" content="Blog page" />
</head>

<body id="top">

  <header class="blog-header" role="banner">
    <span class="brand">
      <a href="index.html"><img src="https://picsum.photos/40" alt="logo" /></a>
      <span class="blog-header-title">The Learning Rate</span>
    </span>
  </header>

  <main class="page blog-main">

    <!-- Search bar -->
    <div class="blog-search-row">
      <button class="blog-search-icon" id="searchToggle" aria-label="Ospen search">
        <svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="10" cy="10" r="8" stroke="#888" stroke-width="2" fill="#f5f5f5" />
          <line x1="16" y1="16" x2="21" y2="21" stroke="#888" stroke-width="2" />
        </svg>
      </button>
      <input type="text" class="blog-search-bar hidden" id="searchBar" placeholder="Search posts..." />
    </div>

    <!-- Template for blog posts -->
    <template id="blogTemplate">
      <article class="blog-post-ref">
        <h2 class="blog-title"></h2>
        <p class="blog-summary"></p>
        <div class="blog-meta-row">
          <a class="blog-readmore">Read more</a>
          <span class="blog-tags"></span>
          <span class="blog-date"></span>
        </div>
      </article>
    </template>

    <!-- Container for posts -->
    <div id="blogContainer"></div>

  </main>

  <script>
    const searchToggle = document.getElementById('searchToggle');
    const searchBar = document.getElementById('searchBar');
    const blogContainer = document.getElementById("blogContainer");
    const blogTemplate = document.getElementById("blogTemplate");
    let allPosts = [];

    /* ----------------------------
       SEARCH BAR TOGGLE
    ---------------------------- */
    searchToggle.addEventListener('click', (e) => {
      searchBar.classList.toggle("hidden");
      if (!searchBar.classList.contains("hidden")) searchBar.focus();
      e.stopPropagation();
    });

    document.addEventListener('click', (e) => {
      const clickedOutside = !searchBar.contains(e.target) && !searchToggle.contains(e.target);
      if (clickedOutside && searchBar.value.trim() === '') {
        searchBar.classList.add("hidden");
      }
    });

    /* ----------------------------
       FETCH BLOG POSTS
    ---------------------------- */
    fetch("posts.json")
      .then(response => response.json())
      .then(posts => {
        allPosts = posts;
        renderPosts([...posts].reverse(), '');
      })
      .catch(err => console.error("Failed to load blog posts:", err));

    /* ----------------------------
       RENDER POSTS WITH HIGHLIGHT
    ---------------------------- */
    function renderPosts(posts, query) {
      blogContainer.innerHTML = '';

      const escapeHTML = (str) => str.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");

      const highlight = (text, query) => {
        if (!query) return escapeHTML(text);
        const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
        return escapeHTML(text).replace(regex, `<span class="highlight">$1</span>`);
      };

      posts.forEach(post => {
        const clone = blogTemplate.content.cloneNode(true);

        clone.querySelector(".blog-title").innerHTML = highlight(post.title, query);
        clone.querySelector(".blog-summary").innerHTML = highlight(post.summary, query);

        const tagsHTML = post.tags.map(tag => highlight(tag, query)).map(tag => `<span class="blog-tag">${tag}</span>`).join('');
        clone.querySelector(".blog-tags").innerHTML = tagsHTML;

        clone.querySelector(".blog-readmore").href = post.link;
        clone.querySelector(".blog-date").textContent = `ðŸ“… ${post.date}`;

        blogContainer.appendChild(clone);
      });
    }

    /* ----------------------------
       LIVE SEARCH FILTER
    ---------------------------- */
    searchBar.addEventListener('input', () => {
      const query = searchBar.value.toLowerCase().trim();
      if (!query) {
        renderPosts(allPosts, '');
      } else {
        const filtered = allPosts.filter(post =>
          post.title.toLowerCase().includes(query) ||
          post.summary.toLowerCase().includes(query) ||
          post.tags.some(tag => tag.toLowerCase().includes(query))
        );
        renderPosts(filtered, query);
      }
    });
  </script>

</body>
</html>
